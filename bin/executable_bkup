#!/usr/bin/env zsh

set -o errexit
set -o nounset
set -o pipefail
if [[ "${TRACE-0}" == "1" ]]; then
    set -o xtrace
fi

notify_failure() {
    local message="$1"
    echo "BACKUP FAILED: $message" >&2
    notify -t "Backup Failed" -s error -u critical "$message"
}

if [[ "${1-}" =~ ^-*h(elp)?$ ]]; then
    echo 'Usage: bkup [dirs_file]

Backup directories listed in dirs_file to tarsnap.
Each directory should be on its own line in the file.
If dirs_file is not specified, defaults to bkup.dirs in the same directory as this script.

Example dirs_file contents:
    ~/Documents
    ~/Photos
    ~/Projects
'
    exit
fi

cd "$(dirname "$0")"

main() {
    # Find tarsnap in common Homebrew locations
    local tarsnap_path
    for prefix in /opt/homebrew /usr/local /home/linuxbrew/.linuxbrew; do
        if [[ -x "${prefix}/bin/tarsnap" ]]; then
            tarsnap_path="${prefix}/bin/tarsnap"
            break
        fi
    done

    if [[ -z "${tarsnap_path:-}" ]]; then
        notify_failure "tarsnap not found in any Homebrew location"
        exit 1
    fi

    # Set default dirs file if not provided
    local dirs_file="${1:-bkup.dirs}"

    if [[ ! -f "$dirs_file" ]]; then
        notify_failure "Dirs file '$dirs_file' does not exist"
        exit 1
    fi

    # Read directories from file
    local dirs=()
    while IFS= read -r dir || [[ -n "$dir" ]]; do
        # Skip empty lines and comments
        [[ -z "$dir" || "$dir" =~ ^[[:space:]]*# ]] && continue
        dirs+=("$dir")
    done < "$dirs_file"

    if [[ ${#dirs[@]} -eq 0 ]]; then
        notify_failure "No valid directories found in '$dirs_file'"
        exit 1
    fi

    # Validate all directories exist
    local missing_dirs=()
    for dir in "${dirs[@]}"; do
        if [[ ! -e "$dir" ]]; then
            missing_dirs+=("$dir")
        fi
    done

    if [[ ${#missing_dirs[@]} -gt 0 ]]; then
        local missing_list=$(printf '%s, ' "${missing_dirs[@]}")
        missing_list=${missing_list%, }
        notify_failure "Directories do not exist: $missing_list"
        exit 1
    fi

    echo "Backing up directories from $dirs_file:" >&2
    printf '%s\n' "${dirs[@]}" >&2

    # Set up archive name
    computer=${HOST%%.*}
    now=$(date +%Y-%m-%d_%H-%M-%S)
    name=${computer}-${now}

    # Create an archive
    if ! "${tarsnap_path}" -c \
        --print-stats \
        --humanize-numbers \
        -f "${name}" \
        "${dirs[@]}"; then
        notify_failure "Archive creation failed for ${name}"
        exit 1
    fi

    #keep the most recent archives
    if ! "${tarsnap_path}" --list-archives | sort -r | tail -n +66 | xargs -n 1 "${tarsnap_path}" -d -f; then
        notify_failure "Archive cleanup failed"
        exit 1
    fi
}

main "$@"
