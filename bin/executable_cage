#!/bin/bash
# cage — run Claude Code in an isolated Apple container (VM-level isolation)
#
# USAGE
#   cage [claude-args]     Run Claude from the current directory
#
# EXAMPLES
#   cd ~/projects/my-app && cage
#   cage --resume
#
# FIRST TIME SETUP
#   1. brew install container
#   2. container system start
#   3. cage-update          # build the image
#   4. cage-login           # authenticate (opens browser, one-time OAuth)
#   5. cage                 # ready
#
# OTHER COMMANDS
#   cage-login              # re-authenticate when token expires
#   cage-update             # rebuild image after Claude Code updates
#
# HOW IT WORKS
#   - Each container is a lightweight Linux VM (Apple Virtualization Framework)
#   - pwd is mounted at /home/claude/workspace — nothing else on your Mac is visible
#   - Credentials persist in the 'claude-creds' container volume
#   - Your ~/.claude config (CLAUDE.md, settings, commands, skills) is synced in read-only
#   - GIT_AUTHOR/COMMITTER name+email are passed as env vars for correct commit identity
#   - Runs as non-root with --dangerously-skip-permissions

set -e

# If we're inside a git worktree, also mount the main .git dir at its original
# absolute path so git can follow the worktree's gitdir pointer and commit.
WORKTREE_MOUNT=""
if COMMON=$(git -C "$(pwd)" rev-parse --git-common-dir 2>/dev/null); then
  GITDIR=$(git -C "$(pwd)" rev-parse --git-dir 2>/dev/null)
  if [ "$COMMON" != "$GITDIR" ]; then
    WORKTREE_MOUNT="--volume $COMMON:$COMMON"
  fi
fi

# Derive a readable container name from the git branch (or directory name)
BRANCH=$(git -C "$(pwd)" branch --show-current 2>/dev/null)
if [ -z "$BRANCH" ]; then
  BRANCH=$(basename "$(pwd)")
fi
CAGE_NAME="cage-$(printf '%s' "$BRANCH" | tr '/' '-' | tr -cd 'a-zA-Z0-9-' | head -c 60)"

# Auto-append numeric suffix if the name is already in use
BASE_NAME="$CAGE_NAME"
SUFFIX=2
while container list 2>/dev/null | grep -qw "$CAGE_NAME"; do
  CAGE_NAME="${BASE_NAME}-${SUFFIX}"
  SUFFIX=$((SUFFIX + 1))
done

exec container run -it --rm \
  --name "$CAGE_NAME" \
  --volume "$(pwd):/home/claude/workspace" \
  --volume "claude-creds:/home/claude/.claude" \
  --volume "$HOME/.claude:/tmp/.claude-host:ro" \
  $WORKTREE_MOUNT \
  --env TERM \
  --env GIT_AUTHOR_NAME="$(git config user.name)" \
  --env GIT_AUTHOR_EMAIL="$(git config user.email)" \
  --env GIT_COMMITTER_NAME="$(git config user.name)" \
  --env GIT_COMMITTER_EMAIL="$(git config user.email)" \
  claude-isolated \
  claude --dangerously-skip-permissions "$@"
