# zmodload zsh/zprof
export ZSH_INIT="$HOME/.zsh"
export ZSH_CACHE_DIR="$ZSH_INIT/cache"
if [[ ! -d $ZSH_CACHE_DIR ]]; then
  mkdir -p "$ZSH_CACHE_DIR"
fi

source "$ZSH_INIT/shell_environment.zsh"

#set SHELL in docker containers
if [[ -z $SHELL ]]; then
  export SHELL=$(which zsh)
fi

if [[ -n $TMUX ]]; then
  #checking for insecure completion folders is slow so disable it
  #in tmux sub-shells keep it at startup to notice bad folders
  export ZSH_DISABLE_COMPFIX=true
fi

#update plugins when out of date
plugins_file="$ZSH_CACHE_DIR/pre_compinit_plugins.zsh"
plugins_src="$ZSH_INIT/pre_compinit_plugins.txt"
if [[ ! -e $plugins_file || $plugins_file -ot "$plugins_src" ]]; then
  echo updating "$plugins_file" ...
  antibody bundle < "$plugins_src" > $plugins_file
fi
source $plugins_file

autoload -Uz compinit && compinit

plugins_file="$ZSH_CACHE_DIR/post_compinit_plugins.zsh"
plugins_src="$ZSH_INIT/post_compinit_plugins.txt"
if [[ ! -e $plugins_file || $plugins_file -ot "$plugins_src" ]]; then
  echo updating "$plugins_file" ...
  antibody bundle < "$plugins_src" > $plugins_file
fi
source $plugins_file

source "$ZSH_INIT/gitenv.zsh"
source "$ZSH_INIT/path.zsh"
source "$ZSH_INIT/dir-aliases.zsh"
source "$ZSH_INIT/funcs.zsh"
source "$ZSH_INIT/custom_p10k.zsh"
source "$ZSH_INIT/fzf.zsh"
source "$ZSH_INIT/check_plugin_update.zsh"

#launch tmux or attach to existing session
if [[ $LAUNCH_TMUX -eq 1 ]] && [[ -z "$TMUX" ]]; then
  cd "$HOME"
  tmux attach 2>/dev/null || exec tmux new
fi

if [[ $INSECURE_DOCKER -eq 1 ]]; then
  export DOCKER_HOST=tcp://127.0.0.1:2375 
fi

#disable tty XON/XOFF via ^S, ^Q
stty -ixon

#omit l and git status from history
HISTIGNORE='l:gst: '

#user for theme to know when to display alternate username
DEFAULT_USER=$(whoami)

export EDITOR=nvim
export LESS=-RFMX
alias vim=nvim
alias v=nvim
alias opn="open_command"
