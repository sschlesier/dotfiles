fuzzy-dir() {
    local base_dir="$1"
    local child_dir="$2"

    if [[ -d "$base_dir" ]]; then
        local fzf_output=$(fd --type d --max-depth 1 '' "$base_dir" -X basename | sort --ignore-case | fzf --no-select-1 --query "$child_dir" --print-query)
        local fzf_exit_code=$?
        local query=$(echo "$fzf_output" | head -n1)
        local selected=$(echo "$fzf_output" | tail -n1)

        if [[ $fzf_exit_code -eq 0 && -n "$selected" ]]
        then
            # fzf exited successfully and something was selected
            local target_dir="$base_dir/$selected"
            if [[ -d "$target_dir" ]]
            then
                cd "$target_dir"
            else
                # Directory doesn't exist, offer to create it
                echo -n "Create directory '$target_dir'? [y/N] "
                read -r response
                if [[ "$response" =~ ^[Yy]$ ]]; then
                    mkdir -p "$target_dir" && cd "$target_dir"
                else
                    echo "Directory creation cancelled."
                fi
            fi
        else
            # fzf was cancelled (exit code 1) or Enter pressed with no selection (exit code 0 but empty selected)
            # In both cases, cd to base_dir
            cd "$base_dir"
        fi
    else
        echo "$base_dir" is not a directory
    fi
}
fuzzy-dir "$@"
