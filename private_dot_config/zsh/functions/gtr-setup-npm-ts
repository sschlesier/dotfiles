gtr-setup-npm-ts() {
  # Configure git-worktree-runner copy settings for the current npm/TypeScript repository.

  local INCLUDE_VALUES=(
    ".env"
    ".claude/settings.local.json"
    ".cursor/**"
  )

  local INCLUDE_DIR_VALUES=(
    "node_modules"
  )

  local EXCLUDE_VALUES=(
    "**/.env.production*"
    "**/secrets.*"
    "**/*.log"
    "node_modules/.cache/**"
    "node_modules/**/.cache/**"
    "node_modules/.bin/**"
  )

  _gtr_setup_usage() {
    cat <<USAGE
Configure git-worktree-runner copy settings for the current npm/TypeScript repo.
Adds include/exclude patterns so .env, node_modules, .cursor, etc. are copied
when switching worktrees. Run from the repo root (must have package.json and
tsconfig.json).

Usage:
  gtr-setup-npm-ts [options]

Options:
  -h, --help       Show this help.
USAGE
  }

  _gtr_setup_log() {
    printf '%s\n' "$*"
  }

  _gtr_setup_err() {
    printf 'gtr-setup-npm-ts: %s\n' "$*" >&2
  }

  _gtr_setup_have_gtr() {
    git gtr config --help >/dev/null 2>&1
  }

  _gtr_setup_repo_is_target() {
    local repo="$1"
    [[ -f "$repo/package.json" ]] && [[ -f "$repo/tsconfig.json" ]]
  }

  _gtr_setup_config_has_value() {
    local repo="$1"
    local key="$2"
    local value="$3"
    git -C "$repo" config --local --get-all "$key" 2>/dev/null | rg -F -x -- "$value" >/dev/null 2>&1
  }

  _gtr_setup_add_config_value() {
    local repo="$1"
    local key="$2"
    local value="$3"

    if _gtr_setup_config_has_value "$repo" "$key" "$value"; then
      _gtr_setup_log "  skip: $key already has '$value'"
      return 0
    fi

    git -C "$repo" gtr config add "$key" "$value" >/dev/null
    _gtr_setup_log "  added: $key = '$value'"
  }

  _gtr_setup_configure_repo() {
    local repo="$1"

    if [[ ! -d "$repo/.git" && ! -f "$repo/.git" ]]; then
      _gtr_setup_log "skip: $repo (not a git repo)"
      return 0
    fi

    if ! _gtr_setup_repo_is_target "$repo"; then
      _gtr_setup_log "skip: $repo (missing package.json or tsconfig.json)"
      return 0
    fi

    _gtr_setup_log "configuring: $repo"

    local v
    for v in "${INCLUDE_VALUES[@]}"; do
      _gtr_setup_add_config_value "$repo" "gtr.copy.include" "$v"
    done

    for v in "${INCLUDE_DIR_VALUES[@]}"; do
      _gtr_setup_add_config_value "$repo" "gtr.copy.includeDirs" "$v"
    done

    for v in "${EXCLUDE_VALUES[@]}"; do
      _gtr_setup_add_config_value "$repo" "gtr.copy.exclude" "$v"
    done
  }

  if ! command -v rg >/dev/null 2>&1; then
    _gtr_setup_err "ripgrep (rg) is required"
    return 1
  fi

  if ! _gtr_setup_have_gtr; then
    _gtr_setup_err "git-worktree-runner is not available (expected: 'git gtr')"
    return 1
  fi

  while [[ $# -gt 0 ]]; do
    case "$1" in
      -h|--help)
        _gtr_setup_usage
        return 0
        ;;
      *)
        _gtr_setup_err "unknown option: $1"
        _gtr_setup_usage
        return 1
        ;;
    esac
    shift
  done

  _gtr_setup_configure_repo "$(pwd)"
}

gtr-setup-npm-ts "$@"
